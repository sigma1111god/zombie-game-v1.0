<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Zombie Survival 3D - v2.0</title>
    <style>
        body { margin: 0; background: #000; color: white; font-family: 'Courier New', monospace; overflow: hidden; }
        #ui { position: absolute; top: 20px; left: 20px; z-index: 10; pointer-events: none; }
        .stat { font-size: 24px; margin-bottom: 8px; text-shadow: 2px 2px #000; }
        #crosshair {
            position: absolute; top: 50%; left: 50%;
            width: 20px; height: 20px; border: 2px solid #0f0;
            border-radius: 50%; transform: translate(-50%, -50%);
            z-index: 5; pointer-events: none;
        }
        #instructions {
            position: absolute; bottom: 20px; left: 50%;
            transform: translateX(-50%); text-align: center;
            background: rgba(0,0,0,0.7); padding: 10px 20px;
        }
    </style>
</head>
<body>

<div id="ui">
    <div class="stat">HEALTH: <span id="health">5</span></div>
    <div class="stat">KILLS: <span id="kills">0</span></div>
    <div class="stat">GUN: <span id="gun">Pistol</span></div>
</div>

<div id="crosshair"></div>
<div id="instructions">CLICK TO START | WASD to Move | MOUSE to Aim | 1-4 to Switch Guns</div>

<script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
</script>

<script type="module">
import * as THREE from 'three';

// --- GAME CONFIG (From Original) ---
const guns = [
    { name: "Pistol", rate: 400, speed: 1.5, damage: 1, unlock: 0, color: 0x888888 },
    { name: "AK-47", rate: 200, speed: 2.0, damage: 2, unlock: 3, color: 0x4a3c2c },
    { name: "M1 Garand", rate: 300, speed: 2.5, damage: 3, unlock: 7, color: 0x5e4a37 },
    { name: "M1A1", rate: 150, speed: 2.8, damage: 4, unlock: 10, color: 0x333333 },
    { name: "Minigun", rate: 70, speed: 3.5, damage: 5, unlock: 16, color: 0x111111 }
];

let player = { health: 5, kills: 0, speed: 0.8, isDead: false };
let currentGunIndex = 0;
let lastShot = 0;
let teammate = null;
const zombies = [];
const bullets = [];
const walls = [];

// --- THREE.JS ENGINE SETUP ---
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x050505);
scene.fog = new THREE.Fog(0x050505, 1, 500);

const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

const light = new THREE.PointLight(0xffffff, 500, 300);
camera.add(light); // Flashlight effect
scene.add(camera);
scene.add(new THREE.AmbientLight(0x404040, 2));

// --- WORLD BUILDING ---
const floorGeo = new THREE.PlaneGeometry(1000, 1000);
const floorMat = new THREE.MeshPhongMaterial({ color: 0x1a1a1a });
const floor = new THREE.Mesh(floorGeo, floorMat);
floor.rotation.x = -Math.PI / 2;
scene.add(floor);

// Bricks/Obstacles
const boxGeo = new THREE.BoxGeometry(10, 20, 10);
const boxMat = new THREE.MeshPhongMaterial({ color: 0x333333 });
for(let i=0; i<50; i++) {
    const box = new THREE.Mesh(boxGeo, boxMat);
    box.position.set(Math.random()*400-200, 10, Math.random()*400-200);
    scene.add(box);
    walls.push(new THREE.Box3().setFromObject(box));
}

// --- INPUTS ---
const keys = {};
let yaw = 0, pitch = 0;

document.addEventListener('click', () => document.body.requestPointerLock());
document.addEventListener('mousemove', (e) => {
    if (document.pointerLockElement) {
        yaw -= e.movementX * 0.002;
        pitch -= e.movementY * 0.002;
        pitch = Math.max(-Math.PI/2, Math.min(Math.PI/2, pitch));
    }
});
window.addEventListener('keydown', (e) => {
    keys[e.code] = true;
    if (e.key >= "1" && e.key <= "5") {
        let i = parseInt(e.key) - 1;
        if (guns[i] && player.kills >= guns[i].unlock) {
            currentGunIndex = i;
            document.getElementById('gun').textContent = guns[i].name;
        }
    }
});
window.addEventListener('keyup', (e) => keys[e.code] = false);
window.addEventListener('mousedown', shoot);

// --- LOGIC FUNCTIONS ---
function shoot() {
    if (player.isDead || !document.pointerLockElement) return;
    const gun = guns[currentGunIndex];
    if (Date.now() - lastShot < gun.rate) return;
    lastShot = Date.now();

    const bulletGeo = new THREE.SphereGeometry(0.2);
    const bulletMat = new THREE.MeshBasicMaterial({ color: 0xffff00 });
    const bullet = new THREE.Mesh(bulletGeo, bulletMat);
    
    bullet.position.copy(camera.position);
    const direction = new THREE.Vector3();
    camera.getWorldDirection(direction);
    
    bullet.userData = { velocity: direction.multiplyScalar(gun.speed), damage: gun.damage, life: 200 };
    scene.add(bullet);
    bullets.push(bullet);
}

function spawnZombie(count) {
    for(let i=0; i<count; i++) {
        const geo = new THREE.CapsuleGeometry(1, 2, 4, 8);
        const mat = new THREE.MeshPhongMaterial({ color: 0xff3333 });
        const z = new THREE.Mesh(geo, mat);
        
        const angle = Math.random() * Math.PI * 2;
        const dist = 100 + Math.random() * 50;
        z.position.set(camera.position.x + Math.cos(angle)*dist, 1.5, camera.position.z + Math.sin(angle)*dist);
        z.userData = { health: 3, speed: 0.15 + Math.random() * 0.1 };
        scene.add(z);
        zombies.push(z);
    }
}

function updateTeammate() {
    if (player.kills >= 20 && !teammate) {
        const geo = new THREE.CapsuleGeometry(0.8, 1.8, 4, 8);
        const mat = new THREE.MeshPhongMaterial({ color: 0x0000ff });
        teammate = new THREE.Mesh(geo, mat);
        teammate.position.copy(camera.position).add(new THREE.Vector3(5,0,5));
        teammate.userData = { lastShot: 0 };
        scene.add(teammate);
    }
}

// --- MAIN LOOP ---
setInterval(() => spawnZombie(3), 5000);

function animate() {
    requestAnimationFrame(animate);
    if (player.isDead) return;

    // Movement
    const dir = new THREE.Vector3();
    if (keys['KeyW']) dir.z -= player.speed;
    if (keys['KeyS']) dir.z += player.speed;
    if (keys['KeyA']) dir.x -= player.speed;
    if (keys['KeyD']) dir.x += player.speed;
    dir.applyQuaternion(camera.quaternion);
    dir.y = 0;
    camera.position.add(dir);
    camera.rotation.set(pitch, yaw, 0, 'YXZ');

    // Bullets
    for (let i = bullets.length - 1; i >= 0; i--) {
        const b = bullets[i];
        b.position.add(b.userData.velocity);
        b.userData.life--;
        if (b.userData.life <= 0) {
            scene.remove(b);
            bullets.splice(i, 1);
        }
    }

    // Zombies AI
    zombies.forEach((z, zi) => {
        const toPlayer = new THREE.Vector3().subVectors(camera.position, z.position);
        toPlayer.y = 0;
        z.position.add(toPlayer.normalize().multiplyScalar(z.userData.speed));

        // Collision with Player
        if (z.position.distanceTo(camera.position) < 2.5) {
            player.health--;
            document.getElementById('health').textContent = player.health;
            zombies.splice(zi, 1);
            scene.remove(z);
            if (player.health <= 0) { player.isDead = true; location.reload(); }
        }

        // Hit by Bullet
        bullets.forEach((b, bi) => {
            if (b.position.distanceTo(z.position) < 1.5) {
                z.userData.health -= b.userData.damage;
                scene.remove(b);
                bullets.splice(bi, 1);
                if (z.userData.health <= 0) {
                    player.kills++;
                    document.getElementById('kills').textContent = player.kills;
                    zombies.splice(zi, 1);
                    scene.remove(z);
                    updateTeammate();
                }
            }
        });
    });

    // Teammate Logic
    if (teammate) {
        const followTarget = camera.position.clone().add(new THREE.Vector3(-4, 0, -4));
        teammate.position.lerp(followTarget, 0.05);
        teammate.position.y = 1.5;

        if (Date.now() - teammate.userData.lastShot > 120 && zombies.length > 0) {
            const target = zombies[0];
            const tDir = new THREE.Vector3().subVectors(target.position, teammate.position).normalize();
            
            const bGeo = new THREE.SphereGeometry(0.15);
            const b = new THREE.Mesh(bGeo, new THREE.MeshBasicMaterial({ color: 0x00ffff }));
            b.position.copy(teammate.position);
            b.userData = { velocity: tDir.multiplyScalar(2.0), damage: 4, life: 100 };
            scene.add(b);
            bullets.push(b);
            teammate.userData.lastShot = Date.now();
        }
    }

    renderer.render(scene, camera);
}

animate();
</script>
</body>
</html>